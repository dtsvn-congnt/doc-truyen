<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto Novel Reader (Fix URL)</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center; padding-top: 30px; background: #f4f4f4; }
        .container { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); width: 90%; max-width: 600px; text-align: center; }
        
        /* √î nh·∫≠p link */
        input[type="text"] { width: 80%; padding: 12px; margin-bottom: 15px; border-radius: 6px; border: 1px solid #ddd; font-size: 14px; color: #333; }
        
        /* N√∫t b·∫•m */
        button { padding: 10px 20px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 6px; font-size: 16px; margin: 5px; transition: 0.2s; }
        button:hover { opacity: 0.9; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .btn-next { background: #28a745; display: none; } 

        /* Thanh ch·ªânh t·ªëc ƒë·ªô */
        .speed-control { margin: 20px 0; padding: 10px; background: #f9f9f9; border-radius: 8px; border: 1px dashed #ccc; }
        .speed-control label { font-weight: bold; margin-right: 10px; }
        input[type="range"] { vertical-align: middle; cursor: pointer; width: 150px; }

        /* Audio Player */
        audio { width: 100%; margin-top: 10px; outline: none; }
        
        #log { margin-top: 15px; font-size: 14px; color: #555; min-height: 20px; font-style: italic; }
        
        .options { margin-top: 15px; text-align: left; display: inline-block; font-size: 14px; }
    </style>
</head>
<body>

    <div class="container">
        <h2>üìñ ƒê·ªçc Truy·ªán T·ª± ƒê·ªông</h2>
        
        <input type="text" id="urlInput" placeholder="D√°n link chapter truy·ªán v√†o ƒë√¢y...">
        <br>
        
        <button onclick="startReading()" id="btnStart">‚ñ∂ B·∫Øt ƒë·∫ßu ƒë·ªçc</button>
        <button onclick="goToNext()" id="btnNext" class="btn-next">‚è≠ Qua ch∆∞∆°ng sau</button>

        <div class="speed-control">
            <label>T·ªëc ƒë·ªô ƒë·ªçc: <span id="speedLabel" style="color: #d9534f;">1.0x</span></label>
            <input type="range" id="speedInput" min="0.5" max="2.0" step="0.25" value="1.0">
        </div>

        <div id="log">S·∫µn s√†ng...</div>
        <audio id="audioPlayer" controls></audio>
        
        <input type="hidden" id="nextUrlHidden">
        
        <div class="options">
            <input type="checkbox" id="autoNext" checked> 
            <label for="autoNext">T·ª± ƒë·ªông chuy·ªÉn ch∆∞∆°ng khi ƒë·ªçc xong</label>
        </div>
    </div>

    <script>
        const log = document.getElementById('log');
        const audioPlayer = document.getElementById('audioPlayer');
        const nextUrlInput = document.getElementById('nextUrlHidden');
        const btnNext = document.getElementById('btnNext');
        const btnStart = document.getElementById('btnStart');
        const urlInput = document.getElementById('urlInput');
        const speedInput = document.getElementById('speedInput');
        const speedLabel = document.getElementById('speedLabel');

        // X·ª≠ l√Ω thanh tr∆∞·ª£t t·ªëc ƒë·ªô
        speedInput.oninput = function() {
            const val = this.value;
            speedLabel.innerText = val + 'x';
            audioPlayer.playbackRate = val; 
        };

        // H√†m ch√≠nh
        async function startReading(urlOverride = null) {
            // N·∫øu c√≥ urlOverride (t·ª©c l√† chuy·ªÉn b√†i), d√πng n√≥. N·∫øu kh√¥ng th√¨ d√πng c√°i trong textbox.
            const currentUrl = urlOverride || urlInput.value;
            
            if (!currentUrl) {
                alert("Vui l√≤ng d√°n link truy·ªán!");
                return;
            }

            // C·∫¨P NH·∫¨T UI NGAY L·∫¨P T·ª®C: TextBox ph·∫£i hi·ªán URL ƒëang x·ª≠ l√Ω
            urlInput.value = currentUrl; 

            log.innerText = "‚è≥ ƒêang c√†o d·ªØ li·ªáu & t·∫°o gi·ªçng n√≥i...";
            btnStart.disabled = true;
            btnNext.style.display = 'none';
            
            // D·ª´ng nh·∫°c c≈©
            audioPlayer.pause();
            audioPlayer.src = "";

            try {
                // G·ªçi API
                const response = await fetch(`/api/speak?url=${encodeURIComponent(currentUrl)}`);

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || "L·ªói k·∫øt n·ªëi Server");
                }

                // L·∫•y header X-Next-Url (Link ch∆∞∆°ng sau)
                const nextLinkHeader = response.headers.get('X-Next-Url');
                const nextLink = nextLinkHeader ? decodeURI(nextLinkHeader) : null;

                // L·∫•y Audio Blob
                const audioBlob = await response.blob();
                const audioUrl = URL.createObjectURL(audioBlob);

                // C·∫≠p nh·∫≠t tr·∫°ng th√°i
                log.innerText = nextLink ? "‚úÖ ƒê√£ t·∫£i xong! C√≥ ch∆∞∆°ng ti·∫øp theo." : "‚úÖ ƒê√£ t·∫£i xong! (H·∫øt truy·ªán)";
                
                // Ph√°t nh·∫°c
                audioPlayer.src = audioUrl;
                
                // Gi·ªØ t·ªëc ƒë·ªô khi ph√°t b√†i m·ªõi
                audioPlayer.onplay = () => {
                    audioPlayer.playbackRate = speedInput.value;
                };
                
                audioPlayer.play();

                // X·ª≠ l√Ω n√∫t Next & L∆∞u link v√†o √¥ ·∫®N (Hidden)
                if (nextLink) {
                    nextUrlInput.value = nextLink;          // L∆∞u link v√†o ch·ªó k√≠n
                    // KH√îNG c·∫≠p nh·∫≠t urlInput ·ªü ƒë√¢y n·ªØa (ƒë·ªÉ n√≥ gi·ªØ nguy√™n link hi·ªán t·∫°i)
                    btnNext.style.display = 'inline-block';
                } else {
                    nextUrlInput.value = "";
                }

                btnStart.disabled = false;

            } catch (err) {
                console.error(err);
                log.innerText = "‚ùå L·ªói: " + err.message;
                btnStart.disabled = false;
            }
        }

        function goToNext() {
            const nextLink = nextUrlInput.value; // L·∫•y link t·ª´ √¥ ·∫©n
            if(nextLink) {
                startReading(nextLink); // G·ªçi h√†m ƒë·ªçc v·ªõi link m·ªõi
                // H√†m startReading ·ªü tr√™n s·∫Ω t·ª± ƒë·ªông c·∫≠p nh·∫≠t urlInput = nextLink ngay d√≤ng ƒë·∫ßu ti√™n
            }
        }

        // T·ª± ƒë·ªông qua b√†i
        audioPlayer.onended = () => {
            const isAuto = document.getElementById('autoNext').checked;
            const nextLink = nextUrlInput.value;

            if (isAuto && nextLink) {
                log.innerText = "üîÑ ƒêang t·ª± ƒë·ªông chuy·ªÉn ch∆∞∆°ng trong 3 gi√¢y...";
                setTimeout(() => {
                    goToNext(); // G·ªçi h√†m goToNext thay v√¨ startReading tr·ª±c ti·∫øp cho g·ªçn
                }, 3000); 
            }
        };
    </script>
</body>
</html>