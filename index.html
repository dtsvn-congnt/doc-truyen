<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto Novel Reader (Si√™u T·ªëc)</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center; padding-top: 30px; background: #f4f4f4; }
        .container { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); width: 90%; max-width: 600px; text-align: center; }
        
        /* √î nh·∫≠p link */
        input[type="text"] { width: 80%; padding: 12px; margin-bottom: 15px; border-radius: 6px; border: 1px solid #ddd; font-size: 14px; color: #333; }
        
        /* N√∫t b·∫•m */
        button { padding: 10px 20px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 6px; font-size: 16px; margin: 5px; transition: 0.2s; }
        button:hover { opacity: 0.9; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .btn-next { background: #28a745; display: none; } 

        /* Thanh ch·ªânh t·ªëc ƒë·ªô */
        .speed-control { margin: 20px 0; padding: 10px; background: #f9f9f9; border-radius: 8px; border: 1px dashed #ccc; }
        .speed-control label { font-weight: bold; margin-right: 10px; }
        input[type="range"] { vertical-align: middle; cursor: pointer; width: 150px; }

        /* Audio Player */
        audio { width: 100%; margin-top: 10px; outline: none; }
        
        #log { margin-top: 15px; font-size: 14px; color: #555; min-height: 20px; font-style: italic; }
        
        .options { margin-top: 15px; text-align: left; display: inline-block; font-size: 14px; }
    </style>
</head>
<body>

    <div class="container">
        <h2>üìñ ƒê·ªçc Truy·ªán T·ª± ƒê·ªông</h2>
        
        <input type="text" id="urlInput" placeholder="D√°n link chapter truy·ªán v√†o ƒë√¢y...">
        <br>
        
        <button onclick="startReading()" id="btnStart">‚ñ∂ B·∫Øt ƒë·∫ßu ƒë·ªçc</button>
        <button onclick="goToNext()" id="btnNext" class="btn-next">‚è≠ Qua ch∆∞∆°ng sau</button>

        <div class="speed-control">
            <label>T·ªëc ƒë·ªô ƒë·ªçc: <span id="speedLabel" style="color: #d9534f;">1.0x</span></label>
            <input type="range" id="speedInput" min="0.5" max="2.0" step="0.25" value="1.0">
        </div>

        <div id="log">S·∫µn s√†ng...</div>
        <audio id="audioPlayer" controls></audio>
        
        <input type="hidden" id="nextUrlHidden">
        
        <div class="options">
            <input type="checkbox" id="autoNext" checked> 
            <label for="autoNext">T·ª± ƒë·ªông chuy·ªÉn ch∆∞∆°ng khi ƒë·ªçc xong</label>
        </div>
    </div>

    <script>
        const log = document.getElementById('log');
        const audioPlayer = document.getElementById('audioPlayer');
        const nextUrlInput = document.getElementById('nextUrlHidden');
        const btnNext = document.getElementById('btnNext');
        const btnStart = document.getElementById('btnStart');
        const urlInput = document.getElementById('urlInput');
        const speedInput = document.getElementById('speedInput');
        const speedLabel = document.getElementById('speedLabel');

        // BI·∫æN QUAN TR·ªåNG: Kho ch·ª©a d·ªØ li·ªáu t·∫£i ng·∫ßm
        let preloadedData = null; 

        // 1. X·ª≠ l√Ω thanh tr∆∞·ª£t t·ªëc ƒë·ªô
        speedInput.oninput = function() {
            const val = this.value;
            speedLabel.innerText = val + 'x';
            audioPlayer.playbackRate = val; 
        };

        // 2. H√†m ch√≠nh: B·∫Øt ƒë·∫ßu ƒë·ªçc
        async function startReading(urlOverride = null) {
            const currentUrl = urlOverride || urlInput.value;
            
            if (!currentUrl) {
                alert("Vui l√≤ng d√°n link truy·ªán!");
                return;
            }

            // C·∫≠p nh·∫≠t giao di·ªán
            urlInput.value = currentUrl; 
            btnStart.disabled = true;
            btnNext.style.display = 'none';

            // --- A. KI·ªÇM TRA H√ÄNG T·ªíN KHO (PRELOAD) ---
            if (preloadedData && preloadedData.url === currentUrl) {
                console.log("‚ö° D√πng h√†ng ƒë√£ t·∫£i s·∫µn (Instant Play)");
                log.innerText = "‚ö° ƒêang ph√°t (Kh√¥ng c·∫ßn t·∫£i l·∫°i)...";
                
                // Ph√°t ngay l·∫≠p t·ª©c
                playAudio(preloadedData.blobUrl, preloadedData.nextLink);

                // ƒêi t·∫£i ng·∫ßm ch∆∞∆°ng K·∫æ TI·∫æP N·ªÆA (G·ªëi ƒë·∫ßu)
                if (preloadedData.nextLink) {
                    prefetchNext(preloadedData.nextLink);
                }

                // X·∫£ kho
                preloadedData = null;
                btnStart.disabled = false;
                return;
            }
            
            // --- B. N·∫æU KH√îNG C√ì S·∫¥N (L·∫ßn ƒë·∫ßu ch·∫°y) ---
            log.innerText = "‚è≥ ƒêang t·∫£i d·ªØ li·ªáu...";
            audioPlayer.pause();
            
            try {
                // T·∫£i ch∆∞∆°ng hi·ªán t·∫°i
                const data = await fetchChapter(currentUrl);
                
                // T·∫£i xong -> Ph√°t lu√¥n
                log.innerText = "‚úÖ T·∫£i xong! ƒêang ph√°t.";
                playAudio(data.blobUrl, data.nextLink);

                // √Çm th·∫ßm ƒëi t·∫£i ch∆∞∆°ng sau
                if (data.nextLink) {
                    prefetchNext(data.nextLink);
                }

                btnStart.disabled = false;

            } catch (err) {
                console.error(err);
                log.innerText = "‚ùå L·ªói: " + err.message;
                btnStart.disabled = false;
            }
        }

        // 3. H√†m g·ªçi API (Fetch)
        async function fetchChapter(url) {
            // N·∫øu b·∫°n c√≥ √¥ nh·∫≠p cookie, h√£y th√™m &cookie=... v√†o url fetch b√™n d∆∞·ªõi
            const response = await fetch(`/api/speak?url=${encodeURIComponent(url)}`);
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(errorText || "L·ªói k·∫øt n·ªëi Server");
            }
            const nextLinkHeader = response.headers.get('X-Next-Url');
            const nextLink = nextLinkHeader ? decodeURI(nextLinkHeader) : null;
            const blob = await response.blob();
            const blobUrl = URL.createObjectURL(blob);

            return { url, blobUrl, nextLink };
        }

        // 4. H√†m t·∫£i ng·∫ßm (Prefetch) - Ch·∫°y ·∫©n
        async function prefetchNext(nextUrl) {
            console.log("üîÑ B·∫Øt ƒë·∫ßu t·∫£i ng·∫ßm ch∆∞∆°ng sau:", nextUrl);
            try {
                const data = await fetchChapter(nextUrl);
                // L∆∞u v√†o kho
                preloadedData = {
                    url: data.url,          
                    blobUrl: data.blobUrl,  
                    nextLink: data.nextLink 
                };
                console.log("‚úÖ T·∫£i ng·∫ßm ho√†n t·∫•t! S·∫µn s√†ng.");
            } catch (e) {
                console.warn("‚ö†Ô∏è T·∫£i ng·∫ßm th·∫•t b·∫°i:", e);
            }
        }

        // 5. H√†m x·ª≠ l√Ω ph√°t nh·∫°c & UI
        function playAudio(blobUrl, nextLink) {
            audioPlayer.src = blobUrl;
            
            // ƒê·∫£m b·∫£o gi·ªØ ƒë√∫ng t·ªëc ƒë·ªô khi b√†i m·ªõi b·∫Øt ƒë·∫ßu
            audioPlayer.onplay = () => {
                audioPlayer.playbackRate = speedInput.value;
            };
            
            audioPlayer.play();

            // Setup n√∫t Next
            if (nextLink) {
                nextUrlInput.value = nextLink; 
                btnNext.style.display = 'inline-block';
            } else {
                nextUrlInput.value = "";
            }
        }

        function goToNext() {
            const nextLink = nextUrlInput.value;
            if(nextLink) {
                startReading(nextLink); 
            }
        }

        // 6. S·ª± ki·ªán khi ƒë·ªçc xong (Auto Next)
        audioPlayer.onended = () => {
            const isAuto = document.getElementById('autoNext').checked;
            const nextLink = nextUrlInput.value;

            if (isAuto && nextLink) {
                log.innerText = "‚è≠ ƒêang chuy·ªÉn ch∆∞∆°ng...";
                // Chuy·ªÉn lu√¥n kh√¥ng c·∫ßn ƒë·ª£i 3s n·ªØa
                goToNext(); 
            }
        };
    </script>
</body>
</html>