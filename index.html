<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đọc Truyện TTS</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; }
        input, textarea, button { width: 100%; margin-bottom: 10px; padding: 10px; box-sizing: border-box; }
        textarea { height: 80px; font-family: monospace; font-size: 12px; }
        button { background: #007bff; color: white; border: none; cursor: pointer; }
        button:hover { background: #0056b3; }
        #audioPlayer { width: 100%; margin-top: 20px; }
        .note { font-size: 0.85em; color: #666; margin-bottom: 10px; }
    </style>
</head>
<body>

    <h1>Đọc Truyện Online</h1>

    <label>Link truyện:</label>
    <input type="text" id="urlInput" placeholder="https://truyenfull.vn/..." />

    <label>Cookie (Nếu bị lỗi 403/Chặn):</label>
    <div class="note">Mẹo: Bấm F12 -> Network -> Reload -> Chọn request đầu -> Copy dòng "Cookie" dán vào đây.</div>
    <textarea id="cookieInput" placeholder="Ví dụ: _ga=GA1.2...; session_id=..."></textarea>

    <button onclick="playTTS()">Đọc ngay</button>

    <p id="status"></p>
    <audio id="audioPlayer" controls></audio>

    <script>
        async function playTTS() {
            const url = document.getElementById('urlInput').value;
            const cookie = document.getElementById('cookieInput').value; // Lấy giá trị cookie
            const status = document.getElementById('status');
            const audio = document.getElementById('audioPlayer');

            if (!url) {
                alert('Vui lòng nhập Link truyện!');
                return;
            }

            status.innerText = "Đang xử lý...";
            audio.style.display = 'none';

            try {
                // Encode cả URL và Cookie để gửi qua đường dẫn an toàn
                const apiUrl = `/api/speak?url=${encodeURIComponent(url)}&cookie=${encodeURIComponent(cookie)}`;
                
                const response = await fetch(apiUrl);

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText);
                }

                // Xử lý Audio Blob
                const blob = await response.blob();
                const audioUrl = URL.createObjectURL(blob);
                audio.src = audioUrl;
                audio.style.display = 'block';
                audio.play();
                status.innerText = "Đang đọc: " + url;

                // Xử lý Next Chapter (Nếu có)
                const nextUrl = response.headers.get('X-Next-Url');
                if (nextUrl) {
                    const decodedNextUrl = decodeURI(nextUrl);
                    console.log("Next Chapter:", decodedNextUrl);
                    // Tự động điền link mới vào ô input để người dùng bấm tiếp cho lẹ
                    document.getElementById('urlInput').value = decodedNextUrl;
                }

            } catch (err) {
                status.innerText = "Lỗi: " + err.message;
                alert("Lỗi: " + err.message);
            }
        }
    </script>
</body>
</html>