<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M√°y ƒê·ªçc (V15 Google MP3)</title>
    <style>
        /* GI·ªÆ NGUY√äN GIAO DI·ªÜN C≈® */
        :root {
            --bg-body: #eef2f3; --bg-container: #ffffff; --text-main: #333333; --text-sub: #666666; --border-color: #dddddd;
            --box-bg: #ffffff; --ctx-prev-color: #888888; --ctx-next-color: #555555;
            --hl-bg: #fff3cd; --hl-border: #ffc107; --hl-text: #856404; --progress-bg: #f8f9fa;
        }
        [data-theme="dark"] {
            --bg-body: #121212; --bg-container: #1e1e1e; --text-main: #e0e0e0; --text-sub: #aaaaaa; --border-color: #333333;
            --box-bg: #252525; --ctx-prev-color: #777777; --ctx-next-color: #cccccc;
            --hl-bg: #3a3000; --hl-border: #665c00; --hl-text: #ffd54f; --progress-bg: #2c2c2c;
        }
        body { font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center; padding-top: 20px; background: var(--bg-body); color: var(--text-main); transition: background 0.3s, color 0.3s; padding-bottom: 50px; }
        .container { background: var(--bg-container); padding: 20px; border-radius: 12px; box-shadow: 0 6px 15px rgba(0,0,0,0.2); width: 95%; max-width: 650px; text-align: center; transition: background 0.3s; }
        input[type="text"] { width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-container); color: var(--text-main); box-sizing: border-box; }
        .control-group { margin: 10px 0; display: flex; justify-content: center; gap: 8px; flex-wrap: wrap; }
        button { padding: 12px 20px; cursor: pointer; color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: 600; transition: 0.2s; touch-action: manipulation; }
        .btn-blue { background: #007bff; min-width: 100px; } .btn-red { background: #dc3545; } .btn-gray { background: #6c757d; } .btn-green { background: #28a745; width: 100%; display: none; margin-top: 15px; padding: 12px; }
        .btn-theme { background: transparent; border: 1px solid var(--text-sub); color: var(--text-main); padding: 5px 10px; font-size: 12px; margin-bottom: 10px; border-radius: 20px; }
        .progress-wrapper { background: var(--progress-bg); padding: 12px; border-radius: 8px; margin: 15px 0; border: 1px solid var(--border-color); }
        input[type="range"] { width: 100%; cursor: pointer; margin: 10px 0; height: 20px; }
        #readingBox { margin-top: 15px; padding: 15px; background: var(--box-bg); border: 1px solid var(--border-color); border-radius: 8px; text-align: left; max-height: 450px; overflow-y: auto; transition: background 0.3s; }
        .ctx-current { color: var(--hl-text); font-size: 20px; font-weight: 600; line-height: 1.6; background: var(--hl-bg); padding: 15px; border-radius: 8px; border-left: 5px solid var(--hl-border); margin: 15px 0; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        
        /* Toggle Switch cho ch·∫ø ƒë·ªô Google */
        .switch-container { display: flex; align-items: center; justify-content: center; margin-top: 15px; gap: 10px; }
        .switch { position: relative; display: inline-block; width: 50px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #2196F3; }
        input:checked + .slider:before { transform: translateX(26px); }
    </style>
</head>
<body>

    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h3 style="margin: 0; color: var(--text-main);">üìñ M√°y ƒê·ªçc (V15 Google)</h3>
            <button onclick="toggleTheme()" class="btn-theme" id="themeBtn">üåô Ch·∫ø ƒë·ªô t·ªëi</button>
        </div>
        
        <input type="text" id="urlInput" placeholder="D√°n link chapter truy·ªán v√†o ƒë√¢y...">
        
        <div class="control-group">
            <button onclick="manualSeek(-1)" class="btn-gray">‚è™ L√πi</button>
            <button onclick="handlePlayButton()" id="btnStart" class="btn-blue">‚ñ∂ ƒê·ªåC</button>
            <button onclick="handleStopButton()" class="btn-red">‚èπ D·ª™NG</button>
            <button onclick="manualSeek(1)" class="btn-gray">Ti·∫øn ‚è©</button>
        </div>

        <div class="progress-wrapper">
            <div style="display:flex; justify-content:space-between; font-size:14px; color: var(--text-sub);">
                <span id="progressLabel">C√¢u: 0 / 0</span>
                <span><span id="speedLabel" style="color: #dc3545;">1.0x</span></span>
            </div>
            <input type="range" id="progressBar" min="0" value="0" step="1" oninput="seekToBar()">
            <div style="margin-top:5px; text-align: center;">
                <input type="range" id="speedInput" min="0.5" max="2.0" step="0.25" value="1.0" style="width: 100px;">
            </div>
        </div>

        <div id="readingBox">S·∫µn s√†ng...</div>
        <div id="statusLog" style="font-size: 13px; color: #666; margin-top: 10px;"></div>

        <div class="switch-container">
            <label class="switch">
                <input type="checkbox" id="useGoogleOnline">
                <span class="slider"></span>
            </label>
            <span style="font-size: 14px; font-weight: bold; color: var(--text-main);">D√πng Google Online (MP3)</span>
        </div>

        <button onclick="goToNext()" id="btnNext" class="btn-green">‚è≠ CH∆Ø∆†NG SAU</button>
        <input type="hidden" id="nextUrlHidden">
        <div style="margin-top: 15px; font-size: 14px;">
            <input type="checkbox" id="autoNext" checked> <label for="autoNext" style="color: var(--text-main)">T·ª± ƒë·ªông chuy·ªÉn ch∆∞∆°ng</label>
        </div>
    </div>

    <script>
        // --- 1. SETUP ---
        const urlInput = document.getElementById('urlInput');
        const readingBox = document.getElementById('readingBox');
        const statusLog = document.getElementById('statusLog');
        const progressBar = document.getElementById('progressBar');
        const progressLabel = document.getElementById('progressLabel');
        const speedInput = document.getElementById('speedInput');
        const nextUrlInput = document.getElementById('nextUrlHidden');
        const btnNext = document.getElementById('btnNext');
        const btnStart = document.getElementById('btnStart');
        const themeBtn = document.getElementById('themeBtn');
        const checkGoogle = document.getElementById('useGoogleOnline');

        // H·ªá th·ªëng c≈© (Native)
        window.synth = window.speechSynthesis;
        window.uttr = null;
        
        // H·ªá th·ªëng m·ªõi (Google Audio MP3)
        let audioPlayer = new Audio();
        let wakeLock = null;

        let state = { sentences: [], index: 0, isReading: false, dataLoaded: false };

        // --- 2. H√ÄM PH√ÅT GOOGLE MP3 (H·ªÜ TH·ªêNG M·ªöI) ---
        function playGoogleAudio(text) {
            // Google TTS gi·ªõi h·∫°n k√Ω t·ª±, n·∫øu c√¢u d√†i qu√° ph·∫£i c·∫Øt b·ªõt (nh∆∞ng code splitTextSmart ƒë√£ l√†m r·ªìi)
            // URL ƒë·∫∑c bi·ªát c·ªßa Google
            const speed = speedInput.value; // Google h·ªó tr·ª£ speed 0.25 -> 2.0 (nh∆∞ng API n√†y ch·ªâ nh·∫≠n 0.24-4.0 th·ª±c t·∫ø h∆°i kh√≥ ch·ªânh)
            // M·∫πo: Client tw-ob cho ph√©p truy c·∫≠p mi·ªÖn ph√≠
            const url = `https://translate.google.com/translate_tts?ie=UTF-8&q=${encodeURIComponent(text)}&tl=vi&client=tw-ob&ttsspeed=${speed}`;
            
            audioPlayer.src = url;
            audioPlayer.playbackRate = parseFloat(speed); // Ch·ªânh t·ªëc ƒë·ªô b·∫±ng HTML5 Audio
            audioPlayer.play().catch(e => {
                console.error("L·ªói ph√°t MP3:", e);
                statusLog.innerText = "‚ö†Ô∏è L·ªói m·∫°ng ho·∫∑c b·ªã ch·∫∑n IP. H√£y th·ª≠ t·∫Øt/b·∫≠t l·∫°i.";
                // N·∫øu l·ªói m·∫°ng, t·ª± ƒë·ªông nh·∫£y c√¢u ti·∫øp ƒë·ªÉ kh√¥ng k·∫πt
                if(state.isReading) setTimeout(() => { state.index++; speakRouter(); }, 1000);
            });

            // Khi ƒë·ªçc xong file MP3 -> Nh·∫£y c√¢u ti·∫øp
            audioPlayer.onended = () => {
                if (state.isReading) {
                    state.index++;
                    speakRouter(); // ƒê·ªá quy
                }
            };

            audioPlayer.onerror = () => {
                console.warn("L·ªói t·∫£i file MP3, b·ªè qua c√¢u n√†y.");
                if (state.isReading) { state.index++; speakRouter(); }
            };
        }

        // --- 3. B·ªò ƒêI·ªÄU H∆Ø·ªöNG (ROUTER) ---
        // H√†m n√†y s·∫Ω quy·∫øt ƒë·ªãnh d√πng c√°ch c≈© hay c√°ch m·ªõi
        function speakRouter() {
            if (!state.isReading) return;
            if (state.index >= state.sentences.length) { onFinishChapter(); return; }

            updateReadingBoxUI();
            updateProgressBar();

            const text = state.sentences[state.index];

            if (checkGoogle.checked) {
                // C√ÅCH 1: D√ôNG GOOGLE MP3 ONLINE
                playGoogleAudio(text);
            } else {
                // C√ÅCH 2: D√ôNG H·ªÜ TH·ªêNG M√ÅY (C≈®)
                speakNative(text);
            }
        }

        // --- 4. H√ÄM PH√ÅT NATIVE (C≈®) ---
        function speakNative(text) {
            window.synth.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            
            // L·∫•y gi·ªçng t·ªët nh·∫•t c√≥ th·ªÉ
            let voices = window.synth.getVoices();
            let voice = voices.find(v => v.lang.includes('vi'));
            if (voice) utterance.voice = voice;

            utterance.rate = parseFloat(speedInput.value);
            utterance.lang = 'vi-VN';
            
            utterance.onend = () => { if (state.isReading) { state.index++; speakRouter(); } };
            utterance.onerror = (e) => { 
                if (e.error === 'interrupted') return;
                if (state.isReading) { state.index++; speakRouter(); } 
            };

            window.uttr = utterance;
            window.synth.speak(utterance);
        }

        // --- 5. ƒêI·ªÄU KHI·ªÇN CHUNG ---
        function unlockAudio() {
            // M·ªìi l·ª≠a cho c·∫£ 2 h·ªá th·ªëng
            if (!window.synth.speaking) {
                const u = new SpeechSynthesisUtterance(" "); u.volume = 0; u.duration=0; window.synth.speak(u);
            }
            // M·ªìi l·ª≠a cho Audio Player
            audioPlayer.play().catch(()=>{}); 
            audioPlayer.pause();
        }

        async function handlePlayButton() {
            unlockAudio();
            requestWakeLock();

            const url = urlInput.value;
            if (!url) { alert("Thi·∫øu Link!"); return; }

            if (state.dataLoaded && !state.isReading) {
                state.isReading = true; speakRouter();
                statusLog.innerText = "‚ñ∂ ƒêang ƒë·ªçc ti·∫øp...";
                return;
            }
            if (!state.dataLoaded) await fetchAndStart(url);
        }

        function handleStopButton() {
            state.isReading = false;
            // D·ª´ng c·∫£ 2 h·ªá th·ªëng
            if (window.uttr) window.uttr.onend = null;
            window.synth.cancel();
            audioPlayer.pause();
            audioPlayer.onended = null;
            
            statusLog.innerText = "‚èπ ƒê√£ d·ª´ng.";
            if (wakeLock) { wakeLock.release(); wakeLock = null; }
        }

        function manualSeek(step) {
            if (!state.dataLoaded) return;
            handleStopButton(); // D·ª´ng t·∫•t c·∫£ tr∆∞·ªõc khi nh·∫£y
            
            state.index += step;
            if (state.index < 0) state.index = 0;
            if (state.index >= state.sentences.length) state.index = state.sentences.length - 1;

            state.isReading = true; 
            unlockAudio(); // Unlock l·∫°i cho ch·∫Øc
            speakRouter(); 
        }

        function seekToBar() {
            if (!state.dataLoaded) return;
            handleStopButton();
            state.index = parseInt(progressBar.value);
            state.isReading = true; 
            unlockAudio();
            speakRouter();
        }

        // --- C√ÅC H√ÄM PH·ª§ TR·ª¢ (GI·ªÆ NGUY√äN) ---
        async function fetchAndStart(url) {
            handleStopButton();
            btnStart.disabled = true; statusLog.innerText = "‚è≥ ƒêang t·∫£i d·ªØ li·ªáu...";
            try {
                const response = await fetch(`/api/speak?url=${encodeURIComponent(url)}`);
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || "L·ªói server");

                state.sentences = splitTextSmart(data.content);
                if (state.sentences.length === 0) throw new Error("Kh√¥ng c√≥ n·ªôi dung");

                state.index = 0; state.dataLoaded = true; state.isReading = true;
                progressBar.max = state.sentences.length - 1; progressBar.value = 0;

                if (data.nextLink) {
                    nextUrlInput.value = data.nextLink; btnNext.style.display = 'block'; btnNext.innerText = "‚è≠ CH∆Ø∆†NG SAU (C√≥ s·∫µn)";
                } else { nextUrlInput.value = ""; btnNext.style.display = 'none'; }

                btnStart.disabled = false;
                unlockAudio();
                speakRouter();

            } catch (err) {
                readingBox.innerText = "‚ùå L·ªói: " + err.message;
                statusLog.innerText = "L·ªói t·∫£i trang."; btnStart.disabled = false;
            }
        }

        function updateReadingBoxUI() {
            if (state.sentences.length === 0) return;
            readingBox.innerHTML = `<div class="ctx-current">${state.sentences[state.index]}</div>`;
        }
        function updateProgressBar() {
            progressBar.value = state.index;
            progressLabel.innerText = `C√¢u: ${state.index + 1} / ${state.sentences.length}`;
        }
        function splitTextSmart(text) {
            if (!text) return [];
            let clean = text.replace(/\.\.+/g, '.');
            clean = clean.replace(/([.?!;\n]+[‚Äù"']*)/g, "$1|");
            return clean.split("|").map(s => s.trim()).filter(s => {
                const hasLetters = /[a-zA-Z0-9\u00C0-\u1EF9]/.test(s);
                return s.length > 0 && hasLetters;
            });
        }
        function toggleTheme() {
            const body = document.body;
            if (body.getAttribute('data-theme') === 'dark') { body.removeAttribute('data-theme'); themeBtn.innerText = "üåô Ch·∫ø ƒë·ªô t·ªëi"; } 
            else { body.setAttribute('data-theme', 'dark'); themeBtn.innerText = "‚òÄÔ∏è Ch·∫ø ƒë·ªô s√°ng"; }
        }
        async function requestWakeLock() { try { if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen'); } catch (e) {} }
        speedInput.oninput = function() { document.getElementById('speedLabel').innerText = this.value + 'x'; };
        function onFinishChapter() {
            const isAuto = document.getElementById('autoNext').checked;
            const nextLink = nextUrlInput.value;
            if (isAuto && nextLink) { statusLog.innerText = "‚è≠ Chuy·ªÉn ch∆∞∆°ng..."; goToNext(); }
            else { statusLog.innerText = "‚úÖ H·∫øt ch∆∞∆°ng."; state.isReading = false; }
        }
        function goToNext() {
            const nextLink = nextUrlInput.value;
            if (nextLink) { state.dataLoaded = false; urlInput.value = nextLink; handlePlayButton(); }
        }
    </script>
</body>
</html>